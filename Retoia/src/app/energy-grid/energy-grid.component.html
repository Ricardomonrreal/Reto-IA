<div class="game-container">
  <div #renderCanvas class="canvas-container"></div>
  
  <!-- âœ… Game Over Overlay -->
  <div class="game-over-overlay" *ngIf="gameOver">
    <div class="game-over-banner">
      <div class="game-over-skull">ğŸ’€</div>
      <div class="game-over-title">GAME OVER</div>
      <div class="game-over-subtitle">Â¡La red colapsÃ³!</div>
      
      <div class="game-over-reason">
        <div class="reason-icon">ğŸ”¥</div>
        <div class="reason-text">{{ gameOverReason }}</div>
      </div>
      
      <div class="game-over-stats">
        <div class="stat-item">
          <span class="stat-label">ğŸ’° Dinero Final:</span>
          <span class="stat-value">{{ money | number:'1.0-2' }}â‚¬</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">âš¡ ProducciÃ³n Total:</span>
          <span class="stat-value">{{ totalProduction | number:'1.0-0' }} kW</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ğŸ  Consumo Total:</span>
          <span class="stat-value">{{ totalConsumption | number:'1.0-0' }} kW</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ğŸ”§ Fuentes Colocadas:</span>
          <span class="stat-value">{{ placedSources.length }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">ğŸ”Œ Cables Instalados:</span>
          <span class="stat-value">{{ powerLines.length }}</span>
        </div>
      </div>
      
      <div class="game-over-message">
        <div class="message-title">ğŸ’¡ CONSEJO:</div>
        <div class="message-text">
          MantÃ©n tus fuentes de energÃ­a con buena salud realizando mantenimiento regular. 
          Usa cables cortos para mayor eficiencia y vigila tu presupuesto.
        </div>
      </div>
      
      <div class="game-over-actions">
        <button class="btn-menu" (click)="goToMenu()">
          ğŸ  MENÃš PRINCIPAL
        </button>
      </div>
    </div>
  </div>

<!-- âœ… WIN Overlay -->
<div class="game-over-overlay" *ngIf="gameWon">
  <div class="victory-banner">
    <div class="victory-trophy">ğŸ†</div>
    <div class="victory-title">Â¡VICTORIA!</div>
    <div class="victory-subtitle">Red ElÃ©ctrica Estable</div>
    
    <div class="victory-message">
      <div class="victory-icon">âš¡</div>
      <div class="victory-text">
        Â¡Excelente trabajo! Has logrado conectar {{ connectedHousesCount }} casas 
        con una red elÃ©ctrica estable. Has demostrado ser un experto en gestiÃ³n 
        de energÃ­a limpia.
      </div>
    </div>
    
    <div class="victory-stats">
      <div class="victory-stat-item">
        <span class="victory-stat-label">ğŸ’° Dinero Final:</span>
        <span class="victory-stat-value">{{ money | number:'1.0-2' }}â‚¬</span>
      </div>
      <div class="victory-stat-item">
        <span class="victory-stat-label">âš¡ ProducciÃ³n Total:</span>
        <span class="victory-stat-value">{{ totalProduction | number:'1.0-0' }} kW</span>
      </div>
      <div class="victory-stat-item">
        <span class="victory-stat-label">ğŸ  Casas Conectadas:</span>
        <span class="victory-stat-value">{{ connectedHousesCount }}/{{ consumers.length }}</span>
      </div>
      <div class="victory-stat-item">
        <span class="victory-stat-label">ğŸ”§ Fuentes Activas:</span>
        <span class="victory-stat-value">{{ placedSources.length }}</span>
      </div>
      <div class="victory-stat-item">
        <span class="victory-stat-label">â™»ï¸ Eficiencia:</span>
        <span class="victory-stat-value">{{ efficiencyPercent }}%</span>
      </div>
      <div class="victory-stat-item">
        <span class="victory-stat-label">ğŸŒ Emisiones:</span>
        <span class="victory-stat-value">{{ totalEmissions | number:'1.0-0' }} kg CO2/h</span>
      </div>
    </div>
    
    <div class="victory-bonus">
      <div class="bonus-title">ğŸŒŸ LOGRO DESBLOQUEADO:</div>
      <div class="bonus-text">
        "Red Estable" - Has conectado exitosamente al menos 3 casas con energÃ­a limpia. 
        Â¡La ciudad confÃ­a en tu gestiÃ³n!
      </div>
    </div>
    
    <div class="victory-actions">
      <button class="btn-main-menu" (click)="goToMenu()">
        ğŸ  MENÃš PRINCIPAL
      </button>
    </div>
  </div>
</div>
  <!-- Panel de Control Principal -->
  <div class="ui-panel">
    <div class="title">âš¡ RED DE ENERGÃA LIMPIA</div>
    
    <!-- Presupuesto -->
    <div class="score">
      ğŸ’° PRESUPUESTO: <span style="color: #ffff00;">{{ money | number:'1.0-2' }}</span>
    </div>

    <!-- EstadÃ­sticas de EnergÃ­a -->
    <div class="energy-stats">
      <div class="stat-row">
        <span class="stat-label">âš¡ ProducciÃ³n:</span>
        <span class="stat-value production">{{ totalProduction | number:'1.0-1' }} kW</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">ğŸ  Consumo:</span>
        <span class="stat-value consumption">{{ totalConsumption | number:'1.0-0' }} kW</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">ğŸ“Š Balance:</span>
        <span class="stat-value" [style.color]="balanceColor">
          {{ energyBalance >= 0 ? '+' : '' }}{{ energyBalance | number:'1.0-1' }} kW
        </span>
      </div>
      <div class="stat-row">
        <span class="stat-label">â™»ï¸ Eficiencia:</span>
        <span class="stat-value efficiency">{{ efficiencyPercent }}%</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">ğŸŒ Emisiones:</span>
        <span class="stat-value emissions">{{ totalEmissions | number:'1.0-0' }} kg CO2/h</span>
      </div>
    </div>
    
    <div class="subtitle">FUENTES DE ENERGÃA:</div>
    
    <!-- Botones de Fuentes de EnergÃ­a -->
    <button 
      *ngFor="let source of energySourcesUI | keyvalue" 
      class="building-btn"
      [class.selected]="selectedSource === source.key"
      [disabled]="money < source.value.cost && selectedSource !== source.key"
      (click)="selectSource(source.key)">
      <span>{{ source.value.icon }} {{ source.value.name }}</span>
      <div class="building-info">
        Costo: {{ source.value.cost }}â‚¬ | {{ source.value.production }}kW
      </div>
    </button>
    
    <!-- SecciÃ³n de Mantenimiento -->
    <div class="subtitle maintenance-section">
      <span style="color: #FFD700;">ğŸ”§ MANTENIMIENTO:</span>
    </div>
    
    <!-- Botones de tipo de mantenimiento -->
    <button 
      *ngFor="let maint of maintenanceTypes | keyvalue"
      class="building-btn maintenance-btn-selector"
      [class.selected]="selectedMaintenanceType === maint.key"
      (click)="selectMaintenanceTypeFromString(maint.key)">
      <span>{{ maint.value.icon }} {{ maint.value.name | uppercase }}</span>
      <div class="building-info">
        Restaura: {{ maint.value.healthRestore }}% | x{{ maint.value.costMultiplier }}
        <span *ngIf="maint.value.bonusEfficiency" style="color: #00AAFF; font-weight: bold;">
          (+{{ maint.value.bonusEfficiency * 100 }}% âš¡ 30s)
        </span>
      </div>
    </button>
    
    <!-- BotÃ³n de Cable -->
    <button 
      class="building-btn cable-btn"
      [class.selected]="selectedSource === 'cable'"
      (click)="selectSource('cable')">
      <span>ğŸ”Œ CONECTAR RED</span>
      <div class="building-info">
        Une fuentes de energÃ­a
      </div>
    </button>

    <!-- BotÃ³n Borrador -->
    <button 
      class="building-btn eraser-btn"
      [class.selected]="selectedSource === 'eraser'"
      (click)="selectSource('eraser')">
      <span>ğŸ—‘ï¸ BORRADOR</span>
    </button>
    
    <div class="instructions-bottom">
      <div style="color: #ffff00; margin-bottom: 5px;">ğŸ’¡ OBJETIVO:</div>
      <div>â€¢ Conectar todas las casas</div>
      <div>â€¢ Mantener fuentes saludables</div>
      <div>â€¢ No quedarte sin dinero</div>
      <div style="margin-top: 8px; border-top: 1px solid #00ff00; padding-top: 8px;">
        <strong>Uso:</strong> Selecciona tipo de mantenimiento â†’ Click en fuente
      </div>
    </div>
  </div>
  <!-- Panel de Salud de Fuentes -->
  <div class="health-panel" *ngIf="placedSources.length > 0">
    <div class="panel-title">ğŸ”§ ESTADO DE FUENTES</div>
    
    <!-- Indicadores de estado especial -->
    <div class="special-status" *ngIf="sourcesInMaintenance > 0 || sourcesWithBonus > 0">
      <div *ngIf="sourcesInMaintenance > 0" class="status-badge maintenance">
        â³ {{ sourcesInMaintenance }} en mantenimiento
      </div>
      <div *ngIf="sourcesWithBonus > 0" class="status-badge bonus">
        âš¡ {{ sourcesWithBonus }} con bonus activo
      </div>
    </div>
    
    <div class="health-list">
      <div *ngFor="let source of placedSources" 
           class="health-item"
           [class.critical]="source.health < 30 && !source.isUnderMaintenance"
           [class.warning]="source.health >= 30 && source.health < 60 && !source.isUnderMaintenance"
           [class.healthy]="source.health >= 60 && !source.isUnderMaintenance"
           [class.maintenance]="source.isUnderMaintenance"
           [class.bonus]="source.bonusEfficiency && !source.isUnderMaintenance">
        
        <div class="health-info">
          <div class="health-header">
            <span class="source-icon">{{ energySources[source.type].icon }}</span>
            <span class="source-location">({{ source.x }},{{ source.z }})</span>
            
            <!-- Indicadores especiales -->
            <span *ngIf="source.isUnderMaintenance" class="status-indicator maintenance-indicator">
              â³
            </span>
            <span *ngIf="source.bonusEfficiency && !source.isUnderMaintenance" 
                  class="status-indicator bonus-indicator">
              âš¡+{{ (source.bonusEfficiency * 100) | number:'1.0-0' }}%
            </span>
            
            <span class="health-percent">{{ source.health | number:'1.0-0' }}%</span>
          </div>
          
          <div class="health-bar-container">
            <div class="health-bar" 
                 [style.width.%]="source.health"
                 [style.background]="source.isUnderMaintenance ? '#FFFF00' : 
                                    source.bonusEfficiency ? '#00AAFF' :
                                    source.health < 30 ? '#ff0000' : 
                                    source.health < 60 ? '#ffaa00' : '#00ff00'">
            </div>
          </div>
          
          <div class="efficiency-text">
            <span>âš¡ Eficiencia: </span>
            <span [style.color]="source.isUnderMaintenance ? '#FFFF00' : 
                                 source.bonusEfficiency ? '#00AAFF' : '#ffffff'">
              {{ source.isUnderMaintenance ? 0 : 
                 (source.efficiency * (source.bonusEfficiency ? 1 + source.bonusEfficiency : 1)) * 100 | number:'1.0-0' }}%
            </span>
            <span *ngIf="source.isUnderMaintenance" style="color: #FFFF00; margin-left: 5px;">
              (En proceso)
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Resumen de salud general -->
    <div class="health-summary">
      <div class="summary-item">
        <span>ğŸŸ¢ Buenas:</span>
        <span>{{ healthySources }}</span>
      </div>
      <div class="summary-item">
        <span>ğŸŸ¡ Advertencia:</span>
        <span>{{ warningSources }}</span>
      </div>
      <div class="summary-item critical-count">
        <span>ğŸ”´ CrÃ­ticas:</span>
        <span>{{ criticalSources }}</span>
      </div>
    </div>
  </div>
  
  <!-- Panel de Instrucciones -->
  <div class="instructions-panel">
    <div class="instructions-title">ğŸ® CONTROLES</div>
    <div>â€¢ <span class="control-highlight">Click</span>: Colocar fuente</div>
    <div>â€¢ <span class="control-highlight">Mantenimiento</span>: Selecciona tipo + Click</div>
    <div>â€¢ <span class="control-highlight">Modo Cable</span>: Click en 2 fuentes</div>
    <div>â€¢ <span class="control-highlight">Mouse Wheel</span>: Zoom</div>
    <div>â€¢ <span class="control-highlight">Click Medio/Der</span>: Mover cÃ¡mara</div>
    <div>â€¢ <span class="control-highlight">WASD</span>: Mover cÃ¡mara</div>
    
    <div class="section-divider">
      <div class="section-title guide">ğŸ“‹ GUÃA RÃPIDA:</div>
      <div class="small-text">
        <div><strong>â˜€ï¸ Solar:</strong> Bajo costo, baja producciÃ³n</div>
        <div><strong>ğŸ’¨ EÃ³lica:</strong> Medio costo, buena producciÃ³n</div>
        <div><strong>ğŸ’§ Hidro:</strong> Alto costo, mÃ¡xima producciÃ³n</div>
        <div><strong>ğŸ”‹ BaterÃ­a:</strong> Almacena energÃ­a</div>
        <div><strong>â˜¢ï¸ Nuclear:</strong> Alto costo, producciÃ³n constante</div>
      </div>
    </div>
    
    <!-- SecciÃ³n de mecÃ¡nicas de mantenimiento -->
    <div class="section-divider">
      <div class="section-title maintenance">ğŸ”§ MANTENIMIENTO:</div>
      <div class="small-text">
        <div><strong>ğŸ”§ BÃ¡sico:</strong> 50% + barato + 2s</div>
        <div><strong>âš™ï¸ EstÃ¡ndar:</strong> 100% restauraciÃ³n + 3s</div>
        <div><strong>âœ¨ Premium:</strong> 100% + bonus 30s + 4s</div>
        <div class="warning-text">
          âš ï¸ ProducciÃ³n = 0 durante proceso
        </div>
        <div class="bonus-text">
          âš¡ Bonus Premium: +10% eficiencia
        </div>
      </div>
    </div>
    
    <!-- SecciÃ³n de nuevas mecÃ¡nicas -->
    <div class="section-divider">
      <div class="section-title mechanics">âš ï¸ MECÃNICAS:</div>
      <div class="small-text">
        <div><strong>ğŸ”§ DegradaciÃ³n:</strong> Las fuentes pierden salud</div>
        <div><strong>âš¡ PÃ©rdida:</strong> Cables largos = menos energÃ­a</div>
        <div><strong class="status-healthy">ğŸŸ¢ Verde:</strong> Salud buena (60-100%)</div>
        <div><strong class="status-warning">ğŸŸ¡ Amarillo:</strong> Necesita mantenciÃ³n (30-60%)</div>
        <div><strong class="status-critical">ğŸ”´ Rojo:</strong> CrÃ­tico + humo (&lt;30%)</div>
        <div><strong class="status-warning">ğŸŸ¡ Parpadeante:</strong> En mantenimiento</div>
        <div><strong class="status-bonus">ğŸ”µ Azul:</strong> Con bonus activo</div>
        <div class="warning-text">
          ğŸ’¡ Cables cortos = mayor eficiencia
        </div>
      </div>
    </div>
  </div>
  
  <!-- Indicador de acciÃ³n actual -->
  <div class="action-indicator" 
       [class.eraser-mode]="selectedSource === 'eraser'"
       [class.cable-mode]="selectedSource === 'cable'"
       [class.maintenance-mode]="selectedSource === 'maintenance'">
    <span *ngIf="selectedSource === 'eraser'">ğŸ—‘ï¸ MODO BORRADOR</span>
    <span *ngIf="selectedSource === 'cable'">ğŸ”Œ MODO CONEXIÃ“N - Click en 2 fuentes</span>
    <span *ngIf="selectedSource === 'maintenance' && selectedMaintenanceType">
      {{ maintenanceTypes[selectedMaintenanceType].icon }} 
      MANTENIMIENTO {{ maintenanceTypes[selectedMaintenanceType].name | uppercase }} 
      - Click en fuente para aplicar
    </span>
    <span *ngIf="selectedSource !== 'eraser' && selectedSource !== 'cable' && selectedSource !== 'maintenance'">
      âš¡ COLOCANDO: {{ energySourcesUI[selectedSource].name || 'NADA' }}
    </span>
  </div>

  <!-- Alerta de Estado -->
  <div class="alert-panel" 
       [class.alert-success]="energyBalance >= 0"
       [class.alert-danger]="energyBalance < 0">
    <div *ngIf="energyBalance >= 0" class="alert-content">
      <span class="alert-icon">âœ…</span>
      <div>
        <strong>RED ESTABLE</strong>
        <div class="alert-sub">ProducciÃ³n supera consumo</div>
      </div>
    </div>
    <div *ngIf="energyBalance < 0" class="alert-content">
      <span class="alert-icon">âš ï¸</span>
      <div>
        <strong>DÃ‰FICIT ENERGÃ‰TICO</strong>
        <div class="alert-sub">Necesitas mÃ¡s fuentes de energÃ­a</div>
      </div>
    </div>
  </div>

  <!-- Notificaciones flotantes -->
  <div class="notifications-container">
    <!-- Alerta de fuente crÃ­tica -->
    <div class="notification notification-critical" 
         *ngIf="criticalSources > 0">
      <span class="notification-icon">âš ï¸</span>
      <div class="notification-content">
        <strong>Â¡ALERTA CRÃTICA!</strong>
        <div>{{ criticalSources }} fuente(s) en estado crÃ­tico</div>
      </div>
    </div>
    
    <!-- Alerta de cables ineficientes -->
    <div class="notification notification-warning" 
         *ngIf="powerLines.length > 0 && hasInefficientCables()">
      <span class="notification-icon">ğŸ“‰</span>
      <div class="notification-content">
        <strong>Cables Ineficientes</strong>
        <div>Algunos cables pierden mucha energÃ­a</div>
      </div>
    </div>
    
    <!-- Alerta de fuentes en mantenimiento -->
    <div class="notification notification-info" 
         *ngIf="sourcesInMaintenance > 0">
      <span class="notification-icon">â³</span>
      <div class="notification-content">
        <strong>Mantenimiento en Progreso</strong>
        <div>{{ sourcesInMaintenance }} fuente(s) sin producir</div>
      </div>
    </div>
    
    <!-- NotificaciÃ³n de bonus activo -->
    <div class="notification notification-bonus" 
         *ngIf="sourcesWithBonus > 0">
      <span class="notification-icon">âš¡</span>
      <div class="notification-content">
        <strong>Bonus Activo!</strong>
        <div>{{ sourcesWithBonus }} fuente(s) con +10% eficiencia</div>
      </div>
    </div>
  </div>

  <!-- Tooltip de ayuda flotante -->
  <div class="help-tooltip" *ngIf="placedSources.length === 0 && !gameOver && !gameWon">
    <div class="tooltip-arrow"></div>
    <div class="tooltip-content">
      <strong>ğŸ‘‹ Â¡Bienvenido!</strong>
      <div>1. Selecciona una fuente de energÃ­a</div>
      <div>2. Click en el mapa para construir</div>
      <div>3. Usa cables ğŸ”Œ para conectar</div>
      <div>4. Selecciona mantenimiento ğŸ”§ cuando necesites</div>
      <div style="margin-top: 8px; color: #ffaa00;">
        ğŸ’¡ Las fuentes se degradan con el tiempo
      </div>
      <div style="color: #00AAFF;">
        âš¡ Premium da bonus temporal de eficiencia
      </div>
    </div>
  </div>

  <!-- BotÃ³n de volver al menÃº -->
  <div class="boton-volver-container">
    <button class="boton-volver" (click)="goToMenu()">
      â¬… Volver a niveles
    </button>
  </div>
</div>